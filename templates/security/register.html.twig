{% extends 'base.html.twig' %}

{% block title %}Inscription{% endblock %}

{% block stylesheets %}
    <style>
        #city-list {
            list-style: none;
            border: solid .5px var(--primary);
            position: absolute;
            width: 100%;
            z-index: 12;
            background:white;
            padding: 0;
        }

        #city-list li:hover {
            background-color: var(--success);
            color: white;
            cursor: pointer;
        }

        .form-group {
            position: relative;
        }
    </style>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div id="bg" style="position:absolute;z-index:-1;left:0;height:375px;"></div>
    
    <center class="py-4">
        <img src="{{ asset('image/logo.png') }}" class="mb-3" style="height: 150px;width: auto;" >
        <p class="text-center text-white"><strong>N'achetez que le nécessaire, pour le reste il y a Kiloukoi!</strong></p>
    </center>

    <div class="row">
        <div class="col-md-10 offset-md-1 col-lg-8 offset-lg-2">
            <div class="card">
                <div class="card-body">
                    {{ form_start(registrationForm, {'attr': {'id': 'registration_form'}} ) }}
                        {{ form_row(registrationForm.email) }}

                        {% if registrationForm.nom is defined %}
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form_row(registrationForm.nom) }}
                                </div>
                                <div class="col-md-6">
                                    {{ form_row(registrationForm.prenom) }}
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if registrationForm.raison_social is defined %}
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form_row(registrationForm.raison_social) }}
                                </div>
                                <div class="col-md-6">
                                    {{ form_row(registrationForm.siret) }}
                                </div>
                            </div>
                        {% endif %}

                        <div class="row">
                            <div class="col-md-6">
                                {{ form_row(registrationForm.password.first , { 'id': 'registration_form_password_first'} )  }}
                            </div>
                            <div class="col-md-6">
                                {{ form_row(registrationForm.password.second, { 'id': 'registration_form_password_second'} ) }}
                            </div>
                        </div>

                        {{ form_row(registrationForm.pseudo) }}

                        <div class="row">
                            <div class="col-md-12">
                                {{ form_row(registrationForm.telephone, { 'id': 'registration_phone'} ) }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                {{ form_row(registrationForm.ville, { 'id': 'registration_city'}) }}
                            </div>
                            <div class="col-md-4">
                                {{ form_row(registrationForm.rue) }}
                            </div>
                            <div class="col-md-4">
                                {{ form_row(registrationForm.cp, { 'id': 'registration_cp'} ) }}
                            </div>
                        </div>

                        {{ form_row(registrationForm.adresse, { 'id': 'registration_adresse'}) }}

                        <div class="row m-3 text-center">
                            <div class="col-md-8 offset-md-2 col-lg-4 offset-lg-4">
                                <img src="{{ asset('image/img-add.png') }}" alt="" class="img-fluid rounded output-image">
                                <div>
                                    {% do registrationForm.avatar.setRendered() %}

                                    <label href="#" type="button" class="btn btn-info btn-block">
                                        <input type="file" accept="image/*" name="{{ registrationForm.avatar.vars.full_name }}" class="d-none input-image"> Changer d'avatar
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="row m-3 text-center">
                            <div class="col-md-8 offset-md-2 col-lg-4 offset-lg-4">
                                {% if form_errors(registrationForm.avatar) %}
                                    <div id="image-validation" class="error-image alert alert-warning">{{ registrationForm.avatar.vars.errors | replace({"ERROR: ": ""}) }}</div>
                                {% else %}
                                    <div id="image-validation" class="error-image d-none alert alert-warning"></div>
                                {% endif %}
                            </div>
                        </div>

                        {# {{ form_row(registrationForm.agreeTerms) }} #}

                        <p class="text-center">( <span class="text-danger font-weight-bold">*</span> ) champs requis.</p>

                        <button type="submit" class="btn btn-primary btn-block" id="btn-submit">
                            <i class="fa fa-btn fa-user"></i> Enregistrer
                        </button>
                    {{ form_end(registrationForm) }}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        $('#registration_cp').attr('disabled', 'disabled');

        var validations = [
            {
                fields: 'input[type="email"]',
                rules : [
                    {
                        regex: /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,
                        message: "Veuillez entrer un email valide."
                    }
                ]
            },
            {
                fields: '#registration_phone',
                rules : [
                    {
                        regex: /^(?:(?:\+|00)33|0)\s*[1-9](?:[\s.-]*\d{2}){4}$/,
                        message: "Veuillez entrer un numero de téléphone valide."
                    }
                ]
            },
            {
                fields: '#registration_form_password_first',
                rules : [
                    {
                        regex: /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{10,}$/,
                        message: "Doit contenir au moins 10 caractères, un majuscule, un minuscule et un caractère spécial."
                    }
                ]
            }
        ];

        validations.forEach( function(element, i) 
        {
            element.rules.forEach( function(rule, j)
            {
                var errorField = `<div id="feedback-${i}-${j}" class="invalid-feedback">${rule.message}</div>`;
                $(errorField).insertAfter( $(element.fields) );
            })

            $(element.fields).change( function()
            {
                if( $(this).val().trim().match(element.rules[0].regex) )
                {
                    $(this).parent().children('.invalid-feedback').removeClass('d-block');
                    $(this).removeClass('is-invalid');
                    $(this).addClass('is-valid');
                }
                else
                {                    
                    $(this).parent().children('.invalid-feedback').addClass('d-block');
                    $(this).addClass('is-invalid');
                    $(this).removeClass('is-valid');
                }
            });
        })

        $('input:not([type="file"])').keyup( function()
        {
            $('#registration_form').removeClass('was-validated');
        })
        
        $(`<div id="feedback-pass-2" class="invalid-feedback">Doit être le même que le champ "Mot de passe"</div>`).insertAfter( $("#registration_form_password_second") );
        $('#registration_form_password_second').change( function()
        {
            if( $(this).val() == $('#registration_form_password_first').val() && !$('#registration_form_password_first').hasClass('is-invalid') )
            {
                $(this).parent().children('.invalid-feedback').removeClass('d-block');
                $(this).removeClass('is-invalid');
                $(this).addClass('is-valid');
            }
            else
            {                    
                $(this).parent().children('.invalid-feedback').addClass('d-block');
                $(this).addClass('is-invalid');
                $(this).removeClass('is-valid');
            }
        });

        $('#registration_form_password_first').change( function()
        {
            if( $('#registration_form_password_second').val() !== '' )
                $('#registration_form_password_second').trigger('change');
        });

        $('#btn-submit').click( function(e)
        {
            e.preventDefault();
            $('input:not([type=file])').trigger('change');
            if( $('input.is-invalid').length > 0 )
            {
                // $('#registration_form').addClass('was-validated');
            }
            else
            {
                var error = false;
                
                for (const element of $('input[required]') ) 
                {
                    if( $(element).val().trim() == '' )
                    {
                        error = true;
                        $(element).addClass('is-invalid')
                        break;
                    }
                }

                if( !error )
                {
                    $('#registration_cp').removeAttr('disabled');
                    $('#registration_form').submit();
                }
            }
        })

        $(`<ul id="city-list" class="d-none"></ul>`).insertAfter( $('#registration_city') );
        $('#registration_city').keyup(function(event)
        {
            var url = "https://datanova.legroupe.laposte.fr/api/records/1.0/search/?dataset=laposte_hexasmal&facet=nom_de_la_commune&facet=code_postal&q=" + $(this).val().trim();
            $.get(url, function(data)
            {
                $('#city-list li').remove();
                data.records.forEach( function(element, i)
                {
                    $('#city-list').append(`
                        <li class="px-2 py-1" data-cp="${ element.fields.code_postal }" data-city="${ element.fields.nom_de_la_commune }">${ element.fields.code_postal } - ${ element.fields.nom_de_la_commune }</li>
                    `);
                });
            })
        });

        $('#registration_city').focusin( function()
        {
            $('#city-list').removeClass('d-none');
        })

        $('#registration_city').focusout( function()
        {
            setTimeout( function()
            {
                $('#city-list').addClass('d-none');
            }, 300)
        })

        $(document).on('click', '#city-list li', function()
        {
            $('#registration_cp').removeClass('is-invalid');
            var city = $(this).attr('data-city');
            var cp   = $(this).attr('data-cp');
            $('#registration_city').val(city);
            $('#registration_cp').val(cp);
            $('#registration_cp').trigger("change");
        })


        $(document).on('change', '.input-image', function(e) 
        {
            var input = this;
            var reader = new FileReader();
            
            reader.onload = function(e) 
            {
                if( e.total < 64000 )
                {
                    $('.error-image').addClass('d-none');
                    $('.output-image').attr('src', e.target.result);
                }
                else
                {
                    $('.output-image').attr('src', "/image/img-add.png");
                    $('.error-image').html('Image trop grande.');
                    $('.error-image').removeClass('d-none');
                    $(input).val(null);
                }
            };
            
            reader.readAsDataURL(input.files[0]); // convert to base64 string
        });
    </script>
{% endblock %}